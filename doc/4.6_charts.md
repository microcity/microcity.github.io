[< 4.5 Mixed Integer Programming](4.5_mixed_integer_programming.md) | [Table of Contents](readme.md)

# 4.6 Charts

MicroCity Web provides chart visualization functionality based on [ECharts](https://echarts.apache.org/en/index.html), which allows you to easily create and manage various types of charts in Lua scripts, including line charts, bar charts, scatter plots, pie charts, and more.

## Chart Mechanism

The chart functionality is implemented by integrating ECharts as the core rendering engine, using Lua scripts (`/lua/lib/table2json.lua`) to convert Lua table structures to JSON configurations required by ECharts, which are then transmitted to the front-end JavaScript environment through the RemoteCall mechanism, enabling chart creation and dynamic updates.

## Library Import

Before using any chart functions, you need to import the chart library:

```lua
-- Import charts library
os.upload('/lua/lib/charts.lua')
require('charts')
```

In all examples below, we assume these import statements have already been included.

## Chart Panel

The chart panel is located on the right side of the MicroCity Web interface and automatically appears when the first chart is created. The panel has the following interactive features:

- **Expand/Collapse**: Click the chart title or panel top bar to expand or collapse the chart
- **Resize**: Drag the left edge to adjust panel width, drag the bottom edge to adjust panel height
- **Right-click Menu**: Right-click the chart title to remove the chart, right-click the panel top bar to clear all charts
- **Toolbar**: Chart's upper-right corner includes data viewing and image export functionality

## Charts API

### <a id='charts.create'> CreateChart (chartId, series, xAxis[, yAxis]) </a>

Creates a chart based on data series and axis information.

**Parameters**:
- `chartId`: String, unique identifier for the chart
- `series`: Table, containing one or more data series definitions
- `xAxis`: Table, X-axis configuration
- `yAxis`: Table, Y-axis configuration (optional)

**Example**:
```lua
-- Create simple line chart
local chartId = "SimpleLineChart"
local series = {
      type = 'line',
      data = {150, 230, 224, 218, 135, 147, 260}
}
local xAxis = {
      type = 'category',
      data = {'Mon','Tue','Wed','Thu','Fri','Sat','Sun'}
}

CreateChart(chartId, series, xAxis)
```

### <a id='charts.createadvanced'> CreateChartAdvanced (chartId, options) </a>

Creates a chart using complete ECharts configuration, providing greater customization flexibility.

**Parameters**:
- `chartId`: String, unique identifier for the chart
- `options`: String or Table, complete ECharts configuration options

**Example**:
```lua
local options = {
  title = {text = "Complex Chart Example"},
  tooltip = {trigger = "axis"},
  legend = {data = {"Evaporation", "Precipitation"},y="bottom"},
  xAxis = {
    type = "category",
    data = {"Jan", "Feb", "Mar", "Apr", "May", "Jun"}
  },
  yAxis = {type = "value"},
  series = {
    {
      name = "Evaporation",
      type = "bar",
      data = {2.0, 4.9, 7.0, 23.2, 25.6, 76.7}
    },
    {
      name = "Precipitation",
      type = "bar",
      data = {2.6, 5.9, 9.0, 26.4, 28.7, 70.7}
    }
  }
}

local json_options = table2json(options)
CreateChartAdvanced("advancedChart", json_options)
```

### <a id='charts.update'> UpdateChart (chartId, options) </a>

Updates an existing chart.

**Parameters**:
- `chartId`: String, identifier of the chart to update
- `options`: String or Table, configuration options to update

**Example**:
```lua
-- Create initial chart
local chartId = "UpdateChartDemo"
local series = {{name = "Real-time Data", type = "line", data = {5, 20, 36}}}
local xAxis = {data = {1, 2, 3}}
CreateChart(chartId, series, xAxis)

-- sleep for 1 second to simulate delay
os.sleep(1000)

-- Later update chart data
local newOptions = {
  series = {{name = "Real-time Data", data = {5, 20, 36, 10, 15}}},
  xAxis = {data = {1, 2, 3, 4, 5}}
}
UpdateChart(chartId, newOptions)
```

### <a id='charts.append'> AppendChartData (chartId, data) </a>

Appends new data points to an existing chart, particularly suitable for real-time data scenarios.

**Parameters**:
- `chartId`: String, identifier of the chart to update
- `data`: Table, containing data to append. For multi-series charts, data should be an array where each element corresponds to a data point for a series

**Example**:
```lua
-- Create chart
local chartId = "envChart"
local series = {
  {
    name = "Temperature",
    type = "line",
    data = {{0,23}, {1,24}, {2,25}}
  },
  {
    name = "Humidity",
    type = "line",
    data = {{0,45}, {1,46}, {2,47}}
  }
}
CreateChart(chartId, series)

-- Append new data points
AppendChartData(chartId, {{3,26}, {3,48}})
```

### <a id='charts.clear'> ClearCharts () </a>

Clears all charts.

**Example**:
```lua
ClearCharts()
```

## Chart Type Examples

### Line Chart

```lua
local series = {
  {
    name = "Sales",
    type = "line",
    data = {120, 132, 101, 134, 90, 230, 210}
  }
}
local xAxis = {data = {"Mon", "Tue", "Wed", "Thu", "Fri", "Sat", "Sun"}}
CreateChart("lineChart", series, xAxis)
```

### Bar Chart

```lua
local series = {
  {
    name = "Sales",
    type = "bar",
    data = {120, 132, 101, 134, 90, 230, 210}
  }
}
local xAxis = {data = {"Mon", "Tue", "Wed", "Thu", "Fri", "Sat", "Sun"}}
CreateChart("barChart", series, xAxis)
```

### Pie Chart

```lua
local series = {
  {
    name = "Access Source",
    type = "pie",
    radius = "55%",
    data = {
      {value = 235, name = "Video Ads"},
      {value = 274, name = "Alliance Ads"},
      {value = 310, name = "Email Marketing"},
      {value = 335, name = "Direct Access"},
      {value = 400, name = "Search Engine"}
    }
  }
}
CreateChart("pieChart", series)
```

### Scatter Plot

```lua
local series = {
  {
    name = "Scatter Data",
    type = "scatter",
    data = {{161.2, 51.6}, {167.5, 59.0}, {159.5, 49.2}, 
            {157.0, 63.0}, {155.8, 53.6}}
  }
}
CreateChart("scatterChart", series)
```

## Real-time Data Update Example

The following example demonstrates how to create a real-time updating chart:

```lua
local data = {
    {
        data = {},
        type = 'line',
        name = 'Temperature'
    },
    {
        data = {},
        type = 'line',
        name = 'Humidity'
    }
}

CreateChart('RealtimeChart', data, {name = 'Time'}, {name = 'Value'})

local id = 1
while scene.render() do
    -- Simulate sensor data
    local temperature = math.random() * 10 + 20  -- 20-30Â°C
    local humidity = math.random() * 20 + 40     -- 40-60%

    -- Add new data points
    AppendChartData('RealtimeChart', {{id, temperature}, {id, humidity}})
    
    id = id + 1
    os.sleep(1000) -- Update every second
end
```

## Notes

1. Each chart must have a unique ID; reusing the same ID will overwrite the original chart
2. After resizing the chart panel, charts automatically adapt to the new dimensions
3. Charts have export and data viewing functions accessible via the toolbar in the upper-right corner
4. Creating too many charts may affect system performance; it's recommended to call `ClearCharts()` when charts are no longer needed

For more ECharts configuration options, please refer to the [ECharts official documentation](https://echarts.apache.org/en/option.html).

[< 4.5 Mixed Integer Programming](4.5_mixed_integer_programming.md) | [Table of Contents](readme.md)